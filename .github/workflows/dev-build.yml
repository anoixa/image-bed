name: Dev Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Build version tag'
        required: false

jobs:
  ########################################
  # Binary AMD64
  ########################################
  build-binary-amd64:
    name: Build Binary (amd64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
          cache: true
      - name: Install libvips
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev pkg-config
      - name: Build
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 1
        run: |
          go build -trimpath \
            -ldflags="-s -w -X 'github.com/anoixa/image-bed/config.Version=manual-${{ github.sha }}'" \
            -o image-bed-linux-amd64 .
      - uses: actions/upload-artifact@v4
        with:
          name: image-bed-linux-amd64
          path: image-bed-linux-amd64

  ########################################
  # Binary ARM64
  ########################################
  build-binary-arm64:
    name: Build Binary (arm64)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
          cache: true
      - name: Install libvips
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev pkg-config
      - name: Build
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 1
        run: |
          go build -trimpath \
            -ldflags="-s -w -X 'github.com/anoixa/image-bed/config.Version=manual-${{ github.sha }}'" \
            -o image-bed-linux-arm64 .
      - uses: actions/upload-artifact@v4
        with:
          name: image-bed-linux-arm64
          path: image-bed-linux-arm64

  ########################################
  # Docker Multi-Arch
  ########################################
  build-docker:
    name: Build Docker Multi-Arch
    runs-on: ubuntu-latest
    needs: [build-binary-amd64, build-binary-arm64]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & Push
        run: |
          IMAGE="ghcr.io/${{ github.repository }}"
          SHA="${{ github.sha }}"
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ${IMAGE}:manual -t ${IMAGE}:manual-${SHA} \
            --push .
